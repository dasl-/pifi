<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi-Fi Settings</title>
    <link rel="stylesheet" href="/assets/settings/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Pi-Fi Settings</h1>
            <a href="/" class="back-link">Back to Pi-Fi</a>
        </header>

        <section class="settings-section">
            <h2>Display</h2>
            <div class="brightness-control">
                <label for="brightness-slider">Brightness</label>
                <div class="slider-container">
                    <input type="range" id="brightness-slider" min="0" max="100" value="100">
                    <span id="brightness-value">100%</span>
                </div>
            </div>
        </section>

        <section class="settings-section">
            <h2>Screensavers</h2>
            <p class="description">Select which screensavers to include in the rotation. Click "Settings" to configure options.</p>

            <div class="screensaver-list" id="screensaver-list">
                <div class="loading">Loading...</div>
            </div>

            <div class="actions">
                <button id="save-btn" class="save-btn" disabled>Save Changes</button>
                <button id="select-all-btn" class="secondary-btn">Select All</button>
                <button id="select-none-btn" class="secondary-btn">Select None</button>
            </div>

            <div id="status-message" class="status-message"></div>
        </section>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function() {
            var originalEnabled = [];
            var screensaverConfigs = {};  // Stores configs for each screensaver
            var brightnessTimeout = null;

            // Load and setup brightness control
            function loadBrightness() {
                $.get('/api/brightness').done(function(data) {
                    if (data.success) {
                        $('#brightness-slider').val(data.brightness);
                        $('#brightness-value').text(data.brightness + '%');
                    }
                });
            }

            function saveBrightness(value) {
                $.post({
                    url: '/api/brightness',
                    data: JSON.stringify({ brightness: value }),
                    contentType: 'application/json'
                }).done(function(data) {
                    if (!data.success) {
                        showStatus('Error saving brightness', 'error');
                    }
                }).fail(function() {
                    showStatus('Failed to save brightness', 'error');
                });
            }

            // Brightness slider handler - debounced to avoid spamming the server
            $('#brightness-slider').on('input', function() {
                var value = $(this).val();
                $('#brightness-value').text(value + '%');

                // Debounce the save
                clearTimeout(brightnessTimeout);
                brightnessTimeout = setTimeout(function() {
                    saveBrightness(value);
                }, 200);
            });

            loadBrightness();

            function loadScreensavers() {
                // Load both screensavers and their configs in parallel
                $.when(
                    $.get('/api/screensavers'),
                    $.get('/api/screensaver_configs')
                ).done(function(screensaversResp, configsResp) {
                    var screensaversData = screensaversResp[0];
                    var configsData = configsResp[0];

                    if (!screensaversData.success) {
                        showStatus('Error loading screensavers', 'error');
                        return;
                    }

                    screensaverConfigs = configsData.configs || {};
                    originalEnabled = screensaversData.enabled.slice();
                    renderScreensavers(screensaversData.screensavers, screensaversData.enabled);
                    $('#save-btn').prop('disabled', true);
                }).fail(function() {
                    showStatus('Failed to load screensavers', 'error');
                });
            }

            function formatConfigKey(key) {
                // Convert snake_case to Title Case
                return key.replace(/_/g, ' ').replace(/\b\w/g, function(l) {
                    return l.toUpperCase();
                });
            }

            function getInputType(value) {
                if (typeof value === 'boolean') return 'checkbox';
                if (typeof value === 'number') return 'number';
                return 'text';
            }

            function renderConfigFields(screensaverId, config, defaults) {
                var fields = [];
                var keys = Object.keys(defaults).sort();

                if (keys.length === 0) {
                    return '<div class="no-config">No configurable options</div>';
                }

                keys.forEach(function(key) {
                    var value = config[key];
                    var defaultValue = defaults[key];
                    var inputType = getInputType(defaultValue);
                    var isModified = JSON.stringify(value) !== JSON.stringify(defaultValue);
                    var modifiedClass = isModified ? ' modified' : '';
                    var modifiedBadge = isModified ? '<span class="modified">*</span>' : '';

                    var inputHtml;
                    if (inputType === 'checkbox') {
                        inputHtml = '<input type="checkbox" class="config-input' + modifiedClass + '" ' +
                            'data-key="' + key + '" data-default="' + defaultValue + '"' +
                            (value ? ' checked' : '') + '>';
                    } else if (inputType === 'number') {
                        var step = (defaultValue % 1 !== 0) ? '0.01' : '1';
                        inputHtml = '<input type="number" class="config-input' + modifiedClass + '" ' +
                            'data-key="' + key + '" data-default="' + defaultValue + '" ' +
                            'value="' + value + '" step="' + step + '">';
                    } else {
                        inputHtml = '<input type="text" class="config-input' + modifiedClass + '" ' +
                            'data-key="' + key + '" data-default="' + defaultValue + '" ' +
                            'value="' + value + '">';
                    }

                    fields.push(
                        '<div class="config-field">' +
                            '<label class="config-label">' + formatConfigKey(key) + modifiedBadge + '</label>' +
                            inputHtml +
                        '</div>'
                    );
                });

                fields.push(
                    '<div class="config-actions">' +
                        '<button class="config-save-btn" data-id="' + screensaverId + '">Save Config</button>' +
                        '<button class="config-reset-btn" data-id="' + screensaverId + '">Reset to Defaults</button>' +
                    '</div>'
                );

                return fields.join('');
            }

            function renderScreensavers(screensavers, enabled) {
                var $list = $('#screensaver-list');
                $list.empty();

                screensavers.forEach(function(s) {
                    var isEnabled = enabled.indexOf(s.id) !== -1;
                    var configData = screensaverConfigs[s.id] || { config: {}, defaults: {} };
                    var hasConfig = Object.keys(configData.defaults).length > 0;

                    var $container = $('<div class="screensaver-container" data-id="' + s.id + '"></div>');

                    var $item = $('<label class="screensaver-item">' +
                        '<input type="checkbox" value="' + s.id + '"' + (isEnabled ? ' checked' : '') + '>' +
                        '<span class="screensaver-info">' +
                            '<span class="screensaver-name">' + s.name + '</span>' +
                            '<span class="screensaver-desc">' + s.description + '</span>' +
                        '</span>' +
                    '</label>');

                    // Add settings button if there are configurable options
                    if (hasConfig) {
                        var $toggle = $('<button class="screensaver-toggle" data-id="' + s.id + '">Settings</button>');
                        $item.append($toggle);
                    }

                    var $config = $('<div class="screensaver-config" data-id="' + s.id + '">' +
                        renderConfigFields(s.id, configData.config, configData.defaults) +
                    '</div>');

                    $container.append($item);
                    $container.append($config);
                    $list.append($container);
                });

                // Enable save button when checkbox changes are made
                $list.find('input[type="checkbox"][value]').on('change', function() {
                    var currentEnabled = getEnabledIds();
                    var hasChanges = !arraysEqual(currentEnabled, originalEnabled);
                    $('#save-btn').prop('disabled', !hasChanges);
                });

                // Handle settings toggle
                $list.on('click', '.screensaver-toggle', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var id = $(this).data('id');
                    var $config = $('.screensaver-config[data-id="' + id + '"]');
                    var $toggle = $(this);

                    $config.toggleClass('expanded');
                    $toggle.toggleClass('active');
                });

                // Handle config save
                $list.on('click', '.config-save-btn', function(e) {
                    e.preventDefault();
                    var screensaverId = $(this).data('id');
                    saveScreensaverConfig(screensaverId);
                });

                // Handle config reset
                $list.on('click', '.config-reset-btn', function(e) {
                    e.preventDefault();
                    var screensaverId = $(this).data('id');
                    resetScreensaverConfig(screensaverId);
                });
            }

            function getConfigValues(screensaverId) {
                var $config = $('.screensaver-config[data-id="' + screensaverId + '"]');
                var values = {};

                $config.find('.config-input').each(function() {
                    var $input = $(this);
                    var key = $input.data('key');
                    var type = $input.attr('type');

                    if (type === 'checkbox') {
                        values[key] = $input.is(':checked');
                    } else if (type === 'number') {
                        var val = $input.val();
                        values[key] = val.indexOf('.') !== -1 ? parseFloat(val) : parseInt(val, 10);
                    } else {
                        values[key] = $input.val();
                    }
                });

                return values;
            }

            function saveScreensaverConfig(screensaverId) {
                var config = getConfigValues(screensaverId);

                $.post({
                    url: '/api/screensaver_config',
                    data: JSON.stringify({
                        screensaver_id: screensaverId,
                        config: config
                    }),
                    contentType: 'application/json'
                }).done(function(data) {
                    if (data.success) {
                        // Update local cache
                        if (!screensaverConfigs[screensaverId]) {
                            screensaverConfigs[screensaverId] = { config: {}, defaults: {} };
                        }
                        screensaverConfigs[screensaverId].config = config;

                        // Update UI to show modified state
                        updateConfigFieldStates(screensaverId);
                        showStatus('Config saved for ' + screensaverId + '. Screensaver restarting...', 'success');
                    } else {
                        showStatus('Error saving config: ' + (data.error || 'Unknown error'), 'error');
                    }
                }).fail(function() {
                    showStatus('Failed to save config', 'error');
                });
            }

            function resetScreensaverConfig(screensaverId) {
                if (!confirm('Reset ' + screensaverId + ' to default settings?')) {
                    return;
                }

                $.post({
                    url: '/api/screensaver_config_reset',
                    data: JSON.stringify({
                        screensaver_id: screensaverId
                    }),
                    contentType: 'application/json'
                }).done(function(data) {
                    if (data.success) {
                        // Reset local cache to defaults
                        var defaults = screensaverConfigs[screensaverId]?.defaults || {};
                        screensaverConfigs[screensaverId].config = Object.assign({}, defaults);

                        // Update UI inputs to default values
                        var $config = $('.screensaver-config[data-id="' + screensaverId + '"]');
                        $config.find('.config-input').each(function() {
                            var $input = $(this);
                            var defaultVal = $input.data('default');
                            var type = $input.attr('type');

                            if (type === 'checkbox') {
                                $input.prop('checked', defaultVal === true || defaultVal === 'true');
                            } else {
                                $input.val(defaultVal);
                            }
                            $input.removeClass('modified');
                        });

                        $config.find('.config-label .modified').remove();
                        showStatus('Config reset for ' + screensaverId + '. Screensaver restarting...', 'success');
                    } else {
                        showStatus('Error resetting config: ' + (data.error || 'Unknown error'), 'error');
                    }
                }).fail(function() {
                    showStatus('Failed to reset config', 'error');
                });
            }

            function updateConfigFieldStates(screensaverId) {
                var $config = $('.screensaver-config[data-id="' + screensaverId + '"]');
                var defaults = screensaverConfigs[screensaverId]?.defaults || {};

                $config.find('.config-input').each(function() {
                    var $input = $(this);
                    var key = $input.data('key');
                    var defaultVal = defaults[key];
                    var currentVal;
                    var type = $input.attr('type');

                    if (type === 'checkbox') {
                        currentVal = $input.is(':checked');
                    } else if (type === 'number') {
                        var val = $input.val();
                        currentVal = val.indexOf('.') !== -1 ? parseFloat(val) : parseInt(val, 10);
                    } else {
                        currentVal = $input.val();
                    }

                    var isModified = JSON.stringify(currentVal) !== JSON.stringify(defaultVal);
                    $input.toggleClass('modified', isModified);

                    // Update label badge
                    var $label = $input.closest('.config-field').find('.config-label');
                    $label.find('.modified').remove();
                    if (isModified) {
                        $label.append('<span class="modified">*</span>');
                    }
                });
            }

            function getEnabledIds() {
                var enabled = [];
                $('#screensaver-list input:checked[value]').each(function() {
                    enabled.push($(this).val());
                });
                return enabled;
            }

            function arraysEqual(a, b) {
                if (a.length !== b.length) return false;
                var sortedA = a.slice().sort();
                var sortedB = b.slice().sort();
                for (var i = 0; i < sortedA.length; i++) {
                    if (sortedA[i] !== sortedB[i]) return false;
                }
                return true;
            }

            function showStatus(message, type) {
                var $status = $('#status-message');
                $status.text(message)
                    .removeClass('success error')
                    .addClass(type)
                    .fadeIn();

                if (type === 'success') {
                    setTimeout(function() {
                        $status.fadeOut();
                    }, 3000);
                }
            }

            $('#save-btn').on('click', function() {
                var enabled = getEnabledIds();

                if (enabled.length === 0) {
                    showStatus('Please select at least one screensaver', 'error');
                    return;
                }

                $.post({
                    url: '/api/screensavers',
                    data: JSON.stringify({ enabled: enabled }),
                    contentType: 'application/json'
                }).done(function(data) {
                    if (data.success) {
                        originalEnabled = enabled.slice();
                        $('#save-btn').prop('disabled', true);
                        showStatus('Settings saved! Screensaver restarting...', 'success');
                    } else {
                        showStatus('Error saving settings', 'error');
                    }
                }).fail(function() {
                    showStatus('Failed to save settings', 'error');
                });
            });

            $('#select-all-btn').on('click', function() {
                $('#screensaver-list input[type="checkbox"][value]').prop('checked', true).trigger('change');
            });

            $('#select-none-btn').on('click', function() {
                $('#screensaver-list input[type="checkbox"][value]').prop('checked', false).trigger('change');
            });

            loadScreensavers();
        });
    </script>
</body>
</html>
